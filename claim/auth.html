<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Claim. Auth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css" media="screen" title="no title">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
    <link rel="stylesheet" href="css/framework7.ios.css">
    <link rel="stylesheet" href="css/framework7.ios.colors.min.css">
  </head>
  <body>
    <div class="nav-bar">
        <h1>claim.</h1>
    </div>
      <div class="wrapper">
        <h2 style="font-weight: 300; margin-top: 50px;">Please enter your 4 digit code to enter claim.</h2>
        <div class="search">
          <input type="password" placeholder="4 digit code" size="4" class="name dig" id="base">
        </div>
        <div class="centerr"><div style="background-color: #e74c3c; margin-top: 20px;" onclick="authUsr()"class="mail-but close-popup" id="authbtn">Login</h1></div></div>
      </div>

    <div class="footer">
      <p>A Henry Confos Production</p>
    </div>
    <script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/framework7.min.js"></script>
    <script type="text/javascript" src="js/jquery.autocomplete.min.js"></script>
    <script type="text/javascript" src="js/sha256.js"></script>
    <script type="text/javascript" src="js/hash.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
      function authUsr() {
        var config = {
          apiKey: "AIzaSyCVLxOfjJAWnURGzZeQxePbbC1yX_GVZMc",
          authDomain: "claim-1e7a8.firebaseapp.com",
          databaseURL: "https://claim-1e7a8.firebaseio.com",
          storageBucket: "",
          messagingSenderId: "923622627127"
        };
        firebase.initializeApp(config);
        var dig = $('.dig').val();
        var hashRef = firebase.database().ref('/hashes/');
        var hashed = hashNum(dig);
        hashRef.on('value', function(snapshot) {
      		var p = snapshot.val();
      		for (var key in p) {
        		if (p.hasOwnProperty(key)) {
              if (key == hashed) {
                //hashed = hash
                // email = pin-claim@jflkjhlkjh.com
                // pass = hash
                var email = ''+dig+'-claim@jflkjhlkjh.com'
                var pass = hashed;
                var redir;
                function getparam() {
                  var query = location.search.substr(1);
                  var result = "";
                  query.split("&").forEach(function(part) {
                    var item = part.split("=");
                    result = decodeURIComponent(item[1]);
                  });
                  return result;
                }
                try {
                  redir = getparam();
                } catch(err) {

                }
                firebase.auth().signInWithEmailAndPassword(email, pass).then(function() {
                  localStorage.setItem('pin', dig);
                  if(redir != 'undefined'){
                    window.location = './claim.html?c='+redir;
                  }else {
                      window.location = './index.html';
                  }
                }, function(error) {
                  var errorCode = error.code;
                  var errorMessage = error.message;
                });
              }
        		}
          }
        });
      }
    </script>
  </body>
</html>
